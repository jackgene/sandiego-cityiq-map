@()

<!DOCTYPE html>
<html lang="en">
  <head>
    <title>San Diego CityIQ Map</title>
    <link rel="stylesheet" media="screen" href="@routes.Assets.versioned("stylesheets/main.css")">
    <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="@routes.Assets.versioned("images/favicon.ico")">
    <link rel="import" href="@routes.Assets.versioned("javascripts/google-map/google-map.html")">
  </head>
  <body>
    <script type="text/javascript" src="@routes.Assets.versioned("javascripts/app.elm.js")"></script>
    <script type="text/javascript">
      let app = Elm.Main.fullscreen();
      let markers = [];

      app.ports.googleMapMarkersCmd.subscribe(function (assets) {
        let map = document.querySelector('google-map').map;
        for (let marker of markers) {
          markers.pop().setMap(null);
        }
        for (let asset of assets) {
          markers.push(
            new google.maps.Marker({
              position: {"lat": asset.latitude, "lng": asset.longitude},
              map: map,
              title: asset.assetType
            })
          );
        }
      });
      setTimeout(
        function() {
          let mapElem = document.querySelector('google-map-wip');
          mapElem.outerHTML = mapElem.outerHTML.replace(/-wip/g, '');
          setTimeout(
            function() {
              let mapElem = document.querySelector('google-map');
              mapElem.addEventListener(
                'google-map-ready',
                function(evt) {
                  evt.target.map.addListener(
                    'bounds_changed',
                    function() {
                      app.ports.boundsChangedSub.send(
                        JSON.parse(JSON.stringify(evt.target.map.getBounds()))
                      );
                    }
                  );
                }
              );
            },
            0
          )
        },
        0
      );
    </script>
  </body>
</html>
